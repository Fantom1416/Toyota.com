!function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){e.exports=function(){"use strict";function e(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)e[r]=n[r]}return e}return function t(n,r){function s(t,s,i){if("undefined"!=typeof document){"number"==typeof(i=e({},r,i)).expires&&(i.expires=new Date(Date.now()+864e5*i.expires)),i.expires&&(i.expires=i.expires.toUTCString()),t=encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var o="";for(var a in i)i[a]&&(o+="; "+a,!0!==i[a]&&(o+="="+i[a].split(";")[0]));return document.cookie=t+"="+n.write(s,t)+o}}return Object.create({set:s,get:function(e){if("undefined"!=typeof document&&(!arguments.length||e)){for(var t=document.cookie?document.cookie.split("; "):[],r={},s=0;s<t.length;s++){var i=t[s].split("="),o=i.slice(1).join("=");try{var a=decodeURIComponent(i[0]);if(r[a]=n.read(o,a),e===a)break}catch(e){}}return e?r[e]:r}},remove:function(t,n){s(t,"",e({},n,{expires:-1}))},withAttributes:function(n){return t(this.converter,e({},this.attributes,n))},withConverter:function(n){return t(e({},this.converter,n),this.attributes)}},{attributes:{value:Object.freeze(r)},converter:{value:Object.freeze(n)}})}({read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"})}()},function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.r(t);class s{constructor(e){r(this,"_value",void 0),r(this,"_subscribed",void 0),this._value=e,this._subscribed=[]}getValue(){return this._value}setValue(e){this._value!==e&&(this._value=e,this._subscribed.forEach(e=>this.callSubscriber(e)))}subscribe(e,{immediate:t}={}){return this._subscribed.push(e),t&&this.callSubscriber(e),()=>this.unsubscribe(e)}async callSubscriber(e){await Promise.resolve(e(this._value))===s.unsubscribeToken&&this.unsubscribe(e)}unsubscribe(e){this._subscribed=this._subscribed.filter(t=>t!==e)}}r(s,"unsubscribeToken",Symbol("unsubscribe"));class i{constructor(e,t,n,s){r(this,"moduleName",void 0),r(this,"minLogLevel",0),r(this,"context",void 0),this.moduleName=`${e}${n?"::"+n:""}`,this.context=s,t&&this.setEnv(t)}setEnv(e){this.minLogLevel="prod"===e?2:"demo"===e?1:0}debug(...e){this.minLogLevel<=0&&console.debug(this.moduleName+": ",...e,this.context)}info(...e){this.minLogLevel<=1&&console.info(this.moduleName+": ",...e,this.context)}log(...e){this.minLogLevel<=1&&console.log(this.moduleName+": ",...e,this.context)}warn(...e){this.minLogLevel<=2&&console.warn(this.moduleName+": ",...e,this.context)}error(...e){this.minLogLevel<=3&&console.error(this.moduleName+": ",...e,this.context)}}var o=new i("dg-auth",void 0,void 0,{host:new URL(window.location.href).host});class a{constructor(){r(this,"isAuthInProgressObservable",void 0),this.isAuthInProgressObservable=new s(!1),a.setObservableOnDataHub(this.isAuthInProgressObservable)}static setObservableOnDataHub(e){var t;const n=window.DGDataHub;n?(null!==(t=n.__internal__)&&void 0!==t||(n.__internal__={}),n.__internal__.isAuthInProgress=e):setTimeout(()=>a.setObservableOnDataHub(e),50)}set isAuthInProgress(e){o.debug("Setting isAuthInProgress",e),this.isAuthInProgressObservable.setValue(e)}get isAuthInProgress(){return this.isAuthInProgressObservable.getValue()}}var u,c=n(0),d=n.n(c);!function(e){e.local="local",e.dev="dev",e.test="test",e.stage="stage",e.demo="demo",e.prod="prod"}(u||(u={}));class l{constructor(e){r(this,"name",void 0),this.name=e}get(){return"true"===(e=this.name,d.a.get(e));var e}set(e){var t;e?function(e,t){d.a.set(e,t,g())}(this.name,""+e):(t=this.name,d.a.remove(t,g()))}}const h=new l("dg_was_auto_logged"),v=new l("dg_show_auto_logged_out_notification");function g(){return{domain:function(e=(()=>{var e,t;return null===(e=window)||void 0===e||null===(t=e.location)||void 0===t?void 0:t.href})()){try{const t=new URL(e).hostname.split(".");return t.length>1?t.slice(t.length-2).join("."):t[0]?t[0]:__IS_LEXUS__?"lexus.com":"tldealersystems.com"}catch{return null}}()||void 0}}class f{constructor(e,t,n){r(this,"key",void 0),r(this,"isEqual",void 0),r(this,"sizeLimit",void 0),this.key=e,this.isEqual=n,this.sizeLimit=t}addItem(e){return this.items.some(t=>this.isSameItem(t,e))?(o.debug("Skipping add because it is already in the list",e),!1):(this.items=[...this.items,e],!0)}get items(){try{const e=d.a.get(this.key),t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}set items(e){const t=e.slice(0,this.sizeLimit),n=JSON.stringify(t);d.a.set(this.key,n,{domain:".toyota.com"})}removeItem(e){this.items=this.items.filter(t=>!this.isSameItem(t,e))}isSameItem(e,t){return"function"==typeof this.isEqual?this.isEqual(e,t):e===t}}var b;function m(e){if(!function(e){if(!e||"object"!=typeof e)throw new w("Must be a truthy object",e);const t=Object.keys(e||{});if(1!==t.length)throw new w("Must have only one key",e);const n=t[0];if(!function(e){return Object.values(b).includes(e)}(n))throw new w(`Key must be an event type, not '${n}'`,e);const r=e[n];if(null==r||!r.env)throw new w("Data must contain an 'env' property",e);if(null==r||!r.requestId)throw new w("Data must contain a 'requestId' property",e);return!0}(e))throw new Error("Invalid event");const t=Object.keys(e)[0];return{type:t,data:e[t]}}function p(e,t){return e.type===t.type&&!!e.data.requestId&&e.data.requestId===t.data.requestId}!function(e){e.tokenRequested="TOKEN_REQUESTED",e.tokenCreated="TOKEN_CREATED",e.tokenDeleted="TOKEN_DELETED"}(b||(b={}));class w extends Error{constructor(e,t){super("Invalid RawAuthEvent: "+e),r(this,"event",void 0),this.event=t}}var y={[u.local]:"https://api.stage.dg.toyota.com",[u.dev]:"https://api.dev.dg.toyota.com",[u.test]:"https://api.test.dg.toyota.com",[u.stage]:"https://api.stage.dg.toyota.com",[u.demo]:"https://api.demo.dg.toyota.com",[u.prod]:"https://api.dg.toyota.com"};function E(e){this.message=e}E.prototype=new Error,E.prototype.name="InvalidCharacterError";var _="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new E("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,r,s=0,i=0,o="";r=t.charAt(i++);~r&&(n=s%4?64*n+r:r,s++%4)?o+=String.fromCharCode(255&n>>(-2*s&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return o};function I(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(_(e).replace(/(.)/g,(function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n})))}(t)}catch(e){return _(t)}}function k(e){this.message=e}k.prototype=new Error,k.prototype.name="InvalidTokenError";var S=function(e,t){if("string"!=typeof e)throw new k("Invalid token specified");var n=!0===(t=t||{}).header?0:1;try{return JSON.parse(I(e.split(".")[n]))}catch(e){throw new k("Invalid token specified: "+e.message)}};const O=new i("getIdToken");function A(e){var t;const n=null!==(t=d.a.get(e))&&void 0!==t?t:null;return function(e){if(!e)return!1;try{return Object.keys(S(e)).length>0}catch{return O.debug("Invalid JWT provided"),!1}}(n)?n:"true"===(null==n?void 0:n.toLowerCase())?(O.debug("Getting id_token information from local storage"),localStorage.getItem(e)):null}class L{constructor(e){r(this,"env",void 0),this.env=e}handleLogin(){const e=this.getBaseUrl()+"/garage/si/handleLogin";return fetch(e,{method:"POST",headers:this.buildHeaders(),credentials:"include"})}handleLogout(){const e=this.getBaseUrl()+"/garage/si/handleLogout";return fetch(e,{method:"POST",headers:this.buildHeaders(),credentials:"include"})}getBaseUrl(){const e=y[this.env];if(!e)throw new Error(`No dgApi url found for env: '${this.env}'`);return e}buildHeaders(){const e=new Headers,t=this.getDgid();t&&e.append("dgid",t);const n=this.getIdToken();return n&&e.append("id_token",n),e}getDgid(){const e="dgid_"+this.env;return d.a.get(e)}getIdToken(){return A("prod"===this.env?"id_token":"id_token_tmnab2cqa")}}class P{constructor(e){r(this,"authState",void 0),r(this,"inProgressEvents",void 0),r(this,"finishedEvents",void 0),this.authState=e,this.inProgressEvents=new f("dg-auth-events-in-progress",10,p),this.finishedEvents=new f("dg-auth-events-finished",10,p)}async finishPendingEvents(){const e=this.inProgressEvents.items;if(e.length>0){o.debug("Finishing pending events",e);for(const t of e)await this.handleEvent(t)}}queueEvents(e){if(e.length>0){o.debug("Queueing events",e);for(const t of e)this.setEventHandlingState("started",t)}}async handleEvent(e){if(this.eventHasAlreadyBeenHandled(e))return o.debug("Skipping event, because it was already handled",e),void this.setEventHandlingState("finished",e);o.info("Handling event",e),this.setEventHandlingState("started",e);try{await this._handleEvent(e),o.debug("Successfully handled event",e)}catch(t){o.error("Error handling event",e,t)}finally{this.setEventHandlingState("finished",e)}}_setAutoLogoutEventCookies(){h.set(!0),v.set(!0)}_removeAutoLogoutEventCookies(){h.set(!1),v.set(!1)}async _handleEvent(e){const t=e.data.env;switch(o.setEnv(t),e.type){case b.tokenRequested:this.authState.isAuthInProgress=!0;break;case b.tokenCreated:await this.processAuth(()=>function(e){return new L(e).handleLogin()}(t)),this._removeAutoLogoutEventCookies();break;case b.tokenDeleted:await this.processAuth(()=>function(e){return new L(e).handleLogout()}(t)),"SESSION_TIMEOUT"===e.data.logout_reason&&this._setAutoLogoutEventCookies();break;default:o.warn("Invalid event type: "+e.type)}}async processAuth(e){this.authState.isAuthInProgress=!0;try{await e()}finally{this.authState.isAuthInProgress=!1}}eventHasAlreadyBeenHandled(e){return this.finishedEvents.items.some(t=>p(t,e))}setEventHandlingState(e,t){"started"===e?this.inProgressEvents.addItem(t):"finished"===e&&(this.inProgressEvents.removeItem(t),this.finishedEvents.addItem(t))}}function C(e){return new Promise(t=>setTimeout(t,e))}const H={delayMs:100,timeoutMs:1e3};function T(e,t,n){const r={...H,...n};return function(e,t){const n={isCanceled:!1},r=setTimeout(()=>n.isCanceled=!0,e);return t(n).finally(()=>clearTimeout(r))}(r.timeoutMs,async e=>{for(;!e.isCanceled;){const e=t();if(e)return e;await C(r.delayMs)}return t()})}async function x(){const e=await async function(){return function(e){if(!e)throw new Error("Event Hub was not truthy");if(!Array.isArray(e.events))throw new Error("Event Hub did not have 'events' property that is an array");return e}(await T(0,j,{delayMs:50,timeoutMs:1e4}))}();return new D(e)}function j(){var e;return null===(e=window.pkce)||void 0===e?void 0:e.eventHistory}class D{constructor(e){r(this,"windowEventHub",void 0),this.windowEventHub=e}getEvents(){const e=this.windowEventHub.events;if(!Array.isArray(e))throw new Error("Event history must be an array");return e.map(e=>m(e))}}(async function(){try{const e=new a,t=await async function(){try{return await x()}catch(e){return o.warn("Unable to create Event Hub",e),null}}();if(!t)return;o.debug("Handling events"),await async function(e,t){const n=new P(t);window.addEventListener("beforeunload",()=>{n.queueEvents(e.getEvents())}),await n.finishPendingEvents();const r=e.getEvents();for(const e of r)await n.handleEvent(e)}(t,e),o.debug("Finished handling events")}catch(e){o.error(e)}})()}]);
//# sourceMappingURL=dg-auth.min.js.map